# Maestro Bot (v1)

Асинхронный Telegram-бот для музыкальной школы. Стек: **Python 3.11+, aiogram 3.x, aiosqlite, python-dotenv**.  
Все даты в БД — **UTC ISO** `YYYY-MM-DDTHH:MM:SSZ`.

## Функции
- Анкета (онбординг) + уведомление админам
- Меню ученика: Новый урок, Урок по коду, Сдать урок, Помощь, Мой прогресс (базовый), О курсе, Оплатить
- Выдача уроков строго по папкам `LNN/TNN` (приоритет: видео → картинки → текст), **порционно по T-блокам**
- Сдача работы (текст/фото/видео/док) + уведомление админам
- Оплата: 3 урока бесплатно, далее “Я оплатил” → карточка админу → ручное подтверждение
- Админ-панель: Статистика, Очередь, Ученики (анкета, удаление), Платежи (подтвердить/отклонить), p_ok/p_back
- Воркеры: напоминания + уведомление при появлении новых уроков

## ENV
Скопируйте `.env.example` в `.env` и заполните:
```
BOT_TOKEN=...
ADMIN_ID=...            # или ADMIN_IDS=comma
DB_PATH=./data/bot.db
LESSONS_PATH=./LESSONS_root
ASSETS_PATH=./assets
TIMEZONE=Asia/Aqtobe
PAYMENT_LINK=https://example.com/pay
PAYMENT_PRICE=999
FREE_LESSONS_LIMIT=3
```

## Старт
```
python -m venv .venv
# Linux/Mac:
source .venv/bin/activate
# Windows PowerShell:
# .\.venv\Scripts\Activate.ps1

pip install -r requirements.txt
python -m bot.tools.migrate_unified
python -m bot.main
```

## Структура уроков
```
LESSONS_root/
  L01/
    T01/
      intro.mp4
      schema.png
      text.md
    T02/
  L02/
    T01/
...
```

## БД (добавлено сверх базовой схемы)
- `points(student_id, source, amount, created_at)` — фиксация бонусов (анкета, модуль 1/2).  
- `payment_requests(student_id, amount, status, created_at, resolved_at)` — заявки «Я оплатил» (dedupe).

> Баллы за уроки считаются по факту одобрения: **100 баллов** за каждый `approved`.  
> Бонусы: `onboarding +50`, `module1 +500` (8 уроков), `module2 +500` (16 уроков).

## Что сделать вручную
1. **Создать `.env`** по образцу и указать:
   - `BOT_TOKEN`, `ADMIN_ID/ADMIN_IDS`
   - `PAYMENT_LINK` (ваша ссылка на оплату)
   - `LESSONS_PATH` (корень с уроками; есть демо `LESSONS_root`)
2. **Наполнить уроки** папками `LNN/TNN` (и/или кодовыми папками `STAR01/T01` и т.п.).
3. **Запустить миграцию** (`python -m bot.tools.migrate_unified`) и **бота** (`python -m bot.main`).
4. **Проверить доступность админ-панели** (ввести `/start` с админского аккаунта).
5. **Ручное подтверждение оплат**: админ получает карточки с кнопками.

## Разница с ТЗ
- Порционная выдача сделана по **T-блокам** (внутри T — все файлы сразу в приоритете).
- Баллы фиксируются через подсчёт approved+события (без отдельной колонки у студента).
- «Мой прогресс» показывает счёт и ранг можно докрутить позже (сейчас — базово).

## DoD (проверка)
1) Новый пользователь — анкета → меню; повторный /start — сразу меню.  
2) «Новый урок» без активки → выдаёт `L01/T01` (или следующий). Повтор — не выдаёт.  
3) «Сдать урок» при активке → статус `submitted`, админам уходит карточка + копия.  
4) Админ `p_back` → статус `returned` + уведомление. Повторная сдача — снова уходит админам.  
5) Админ `p_ok` → статус `approved` + модульные бонусы; «Новый урок» даёт следующий.  
6) Нет новых уроков → `waiting_lessons=1`; при добавлении `LNN` с большим номером → придёт уведомление.  
7) Напоминания: приходят, `remind_at` сдвигается корректно (UTC-aware).  
8) Админ «Ученики → Удалить» — каскадно удаляет.  
9) «Оплатить» — заявка «Я оплатил», подтверждение открывает доступ с 4-го урока.
